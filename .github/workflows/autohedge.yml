name: AutoHedge
on:
  workflow_dispatch:
    inputs:
      mode:
        description: dry-run ou live
        required: true
        default: dry-run
  schedule:
    - cron: "*/30 * * * *"

env:
  RPC_URL: ${{ vars.RPC_URL || 'https://api.mainnet-beta.solana.com' }}
  WALLET_KEYPATH: ${{ vars.WALLET_KEYPATH || '/Users/jonathan/.keys/jlp-exec.json' }}
  DRIFT_USER_ID: ${{ vars.DRIFT_USER_ID || 'CHANGE_ME' }}
  DRIFT_SUBACCOUNT_ID: ${{ vars.DRIFT_SUBACCOUNT_ID || '0' }}
  TARGET_LEVERAGE: ${{ vars.TARGET_LEVERAGE || '2' }}
  HEDGE_EXCHANGE: 'drift'
  JLP_WEIGHTS_SOURCE: ${{ vars.JLP_WEIGHTS_SOURCE || 'https://example.com/jlp_weights.json' }}
  SLIPPAGE_BPS: ${{ vars.SLIPPAGE_BPS || '20' }}
  MAX_REHEDGE_INTERVAL_SEC: ${{ vars.MAX_REHEDGE_INTERVAL_SEC || '900' }}

jobs:
  hedge:
    runs-on: [self-hosted, macOS, jlp]
    steps:
      - uses: actions/checkout@v4

      - name: PrÃ©flight
        run: |
          echo "Host=$(hostname) User=$USER"
          test -f "$WALLET_KEYPATH" && echo "Wallet OK" || (echo "Wallet introuvable"; exit 1)

      - name: Dry run
        if: ${{ github.event_name == 'schedule' || inputs.mode == 'dry-run' }}
        run: |
          chmod +x ./run.sh || true
          source ./runner.env 2>/dev/null || true
          ./run.sh --dry-run

      - name: Live
        if: ${{ inputs.mode == 'live' }}
        run: |
          chmod +x ./run.sh || true
          source ./runner.env 2>/dev/null || true
          ./run.sh
