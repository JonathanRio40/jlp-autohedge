name: AutoHedge
on:
  workflow_dispatch:
    inputs:
      mode:
        description: dry-run ou live
        required: true
        default: dry-run
      confirm_live:
        description: Tape YES pour exécuter en live
        required: false
        default: ""
  schedule:
    - cron: "*/30 * * * *"

env:
  RUN_SCRIPT_PATH: ./run.sh

  RPC_URL: ${{ vars.RPC_URL || 'https://api.mainnet-beta.solana.com' }}
  WALLET_KEYPATH: ${{ vars.WALLET_KEYPATH || '/Users/jonathan/.keys/jlp-exec.json' }}
  DRIFT_USER_ID: ${{ vars.DRIFT_USER_ID || 'MISSING' }}
  DRIFT_SUBACCOUNT_ID: ${{ vars.DRIFT_SUBACCOUNT_ID || '0' }}
  TARGET_LEVERAGE: ${{ vars.TARGET_LEVERAGE || '2' }}
  SLIPPAGE_BPS: ${{ vars.SLIPPAGE_BPS || '20' }}
  MAX_REHEDGE_INTERVAL_SEC: ${{ vars.MAX_REHEDGE_INTERVAL_SEC || '900' }}
  POSITION_JLP_USD: ${{ vars.POSITION_JLP_USD || '0' }}
  JLP_WEIGHTS_SOURCE: ${{ vars.JLP_WEIGHTS_SOURCE || '' }}

jobs:
  hedge:
    runs-on: [self-hosted, macOS, jlp]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Préflight & debug
        run: |
          set -e
          echo "Host=$(hostname)  User=$USER  PWD=$PWD"
          ls -la
          echo "--- ENV (clés principales) ---"
          echo "DRIFT_USER_ID=$DRIFT_USER_ID"
          echo "DRIFT_SUBACCOUNT_ID=$DRIFT_SUBACCOUNT_ID"
          echo "WALLET_KEYPATH=$WALLET_KEYPATH"
          echo "RPC_URL=$RPC_URL"
          echo "POSITION_JLP_USD=$POSITION_JLP_USD"
          echo "JLP_WEIGHTS_SOURCE=$JLP_WEIGHTS_SOURCE"
          test -f "$RUN_SCRIPT_PATH" || (echo "ERREUR: $RUN_SCRIPT_PATH introuvable"; exit 1)
          test -f "$WALLET_KEYPATH" || (echo "ERREUR: Wallet introuvable ($WALLET_KEYPATH)"; exit 1)
          if [ -n "$JLP_WEIGHTS_SOURCE" ]; then
            echo "--- HEAD JLP_WEIGHTS_SOURCE ---"
            curl -sSIL "$JLP_WEIGHTS_SOURCE" || true
            echo "--- Début contenu ---"
            curl -sS "$JLP_WEIGHTS_SOURCE" | head -n 20 || true
          else
            echo "ATTENTION: JLP_WEIGHTS_SOURCE non défini"
          fi

      - name: Dry-run
        if: ${{ github.event.inputs.mode != 'live' }}
        run: |
          chmod +x "$RUN_SCRIPT_PATH" || true
          bash "$RUN_SCRIPT_PATH" --dry-run

      - name: Live
        if: ${{ github.event.inputs.mode == 'live' && github.event.inputs.confirm_live == 'YES' }}
        run: |
          chmod +x "$RUN_SCRIPT_PATH" || true
          bash "$RUN_SCRIPT_PATH"
